"use strict";if("undefined"==typeof Trelloviz)var Trelloviz={};if(Trelloviz.viewModel={apiKey:ko.observable(""),loggedIn:ko.observable(!1),showSpinner:ko.observable(!1),fullTrelloUserName:ko.observable(""),trelloLists:ko.observableArray([]),html5LocalStorageAvailable:ko.observable(!1),core_option_keepArchiveCards:ko.observable(!1),areaChart:null,vizDataForJit:null,showConfigPanel:ko.observable(!1),toggleConfigApiKeyPanelVisible:function(){var visible=Trelloviz.viewModel.showConfigPanel();Trelloviz.viewModel.showConfigPanel(!visible)},actionListsUpdated:function(){this.updateVizDataFromTrelloListsSettings(),this.areaChart.loadJSON(this.vizDataForJit)},updateVizDataFromTrelloListsSettings:function(){for(var trellolists=this.trelloLists(),jitdata=this.vizDataForJit,index=trellolists.length;index--;)jitdata.color[index]=trellolists[index].color()},actionLogIn:function(){var apikey=Trelloviz.viewModel.apiKey();null!=apikey&&32==apikey.length?(Trelloviz.viewModel.showConfigPanel(!1),jQuery.getScript("https://api.trello.com/1/client.js?key="+apikey,Trelloviz.trelloLogin)):Trelloviz.viewModel.showConfigPanel(!0)},actionLogOut:function(){Trelloviz.viewModel.loggedIn(!1),Trello.deauthorize()},actionSaveApiKeyToLocalStorage:function(){localStorage.trelloviz_api_key=this.apiKey()},setNewData:function(trellodata){Trelloviz.viewModel.showSpinner(!1);var opts={};opts.keepArchivedCards=Trelloviz.viewModel.core_option_keepArchiveCards();var engine=new Trelloviz.Core.Engine(opts);Trelloviz.viewModel.vizDataForJit=engine.computeVizData_all_lists(trellodata),Trelloviz.viewModel.areaChart=Trelloviz.showGraphic(Trelloviz.viewModel.vizDataForJit);var listsWithNaturalOrder=engine.retrieveListsWithNaturalOrder();listsWithNaturalOrder.forEach(function(item){item.color=ko.observable(item.color)}),Trelloviz.viewModel.trelloLists(listsWithNaturalOrder)}},Trelloviz.trelloLoadAndShowUserInfo=function(){this.viewModel.showSpinner(!0),Trello.members.get("me",function(member){Trelloviz.viewModel.fullTrelloUserName(member.fullName),Trelloviz.viewModel.showSpinner(!1)})},Trelloviz.trelloLoadAndShowBoards=function(){this.viewModel.showSpinner(!0),Trello.get("members/me/boards",{},Trelloviz.showBoards)},Trelloviz.onAuthorize=function(){Trelloviz.viewModel.showSpinner(!1);var reallyLoggedIn="undefined"!=typeof Trello&&Trello.authorized();Trelloviz.viewModel.loggedIn(reallyLoggedIn),reallyLoggedIn&&(Trelloviz.trelloLoadAndShowUserInfo(),$("#loggedin").fadeIn().delay(2e3).fadeOut(),Trelloviz.trelloLoadAndShowBoards())},Trelloviz.onAuthorizeError=function(){Trelloviz.viewModel.loggedIn(!1),Trelloviz.viewModel.showSpinner(!1)},Trelloviz.trelloLogin=function(){Trelloviz.viewModel.showSpinner(!0),Trello.authorize({interactive:!0,type:"popup",success:Trelloviz.onAuthorize,error:Trelloviz.onAuthorizeError,expiration:"1day",scope:{read:!0,write:!1}})},Trelloviz.onShowActionForBoard=function(boardId){Trelloviz.viewModel.showSpinner(!0),Trello.get("boards/"+boardId+"/actions",{limit:"1000"},Trelloviz.viewModel.setNewData)},Trelloviz.showBoards=function(boards){Trelloviz.viewModel.showSpinner(!1),$("#selectBoardCombo").empty(),$("#btnShowChart").click(function(){var selectedBoardId=$("#selectBoardCombo").val();Trelloviz.onShowActionForBoard(selectedBoardId)}),$.each(boards,function(idx,board){$("<option value="+board.id+">").text(board.name).appendTo("#selectBoardCombo")})},Trelloviz.showGraphic=function(viz_data){$("#graphic").empty(),$('<div id="viz_container" style="min-height: 700px">').appendTo("#graphic"),$('<div id="viz_canvas" style="min-height: 700px">').appendTo("#viz_container");var areaChart=new $jit.AreaChart({injectInto:"viz_canvas",animate:!0,Margin:{top:5,left:5,right:5,bottom:5},labelOffset:10,showAggregates:!0,showLabels:!0,type:"stacked:gradient",Tips:{enable:!0,onShow:function(tip,elem){$(tip).empty(),$("<span>").addClass("label").addClass("label-info").text(""+elem.name+" ("+elem.value+")").appendTo(tip)}},filterOnClick:!1,restoreOnRightClick:!0});return areaChart.loadJSON(viz_data),areaChart},function(){"undefined"!=typeof Storage&&(Trelloviz.viewModel.html5LocalStorageAvailable(!0),localStorage.trelloviz_api_key&&Trelloviz.viewModel.apiKey(localStorage.trelloviz_api_key))}(),"undefined"==typeof Trelloviz)var Trelloviz={};Trelloviz.Core={},Trelloviz.Core.Engine=function(options){function isKeepArchivedCards(){return _options.keepArchivedCards}options=options||{};var _options={};return _options.keepArchivedCards="undefined"!=typeof options.keepArchivedCards?options.keepArchivedCards:!1,{defaultColors:[],listOrder:{},counterPerList:{},cardToListMap:{},vizDataForJit:{label:[],values:[],color:[]},reset_properties:function(){this.defaultColors=["#416D9C","#70A35E","#EBB056","#C74243","#83548B","#909291","#557EAA"],this.listOrder={},this.counterPerList={},this.cardToListMap={},this.vizDataForJit={label:[],values:[],color:[]}},computeVizData_all_lists:function(trelloActionData){this.reset_properties(),this.sortTrelloDataByDateAscending(trelloActionData);for(var idx=0;idx<trelloActionData.length;idx++)this.processSingleTrelloActionRecord(idx,trelloActionData[idx]);return this.retrieveLabelNamesFromList(),this.cleanupNullValues(),this.vizDataForJit},cleanupNullValues:function(){this.vizDataForJit.values.forEach(function(element){for(var i=0,len=element.values.length;len>i;i++)element.values[i]=element.values[i]||0},this)},sortTrelloDataByDateAscending:function(trelloActionData){trelloActionData.sort(function(a,b){var unixtimestamp_a=Date.parse(a.date),unixtimestamp_b=Date.parse(b.date);return unixtimestamp_b>unixtimestamp_a?-1:unixtimestamp_a>unixtimestamp_b?1:0})},actionArchiveCard:function(trelloActionRecord){if(!isKeepArchivedCards()){var listid=this.cardToListMap[trelloActionRecord.data.card.id];if(listid){if(this.counterPerList[listid]<=0){this.counterPerList[listid]=1;for(var idx=this.listOrder[listid].listIdx,i=this.vizDataForJit.values.length-1;i>=0;i--)this.vizDataForJit.values[i].values[idx]=(this.vizDataForJit.values[i].values[idx]||0)+1}return this.counterPerList[listid]--,!0}return!1}},actionCreateCard:function(trelloActionRecord){var listid=trelloActionRecord.data.list.id;this.ensureListIsRegistered(trelloActionRecord.data.list),this.counterPerList[listid]++,this.cardToListMap[trelloActionRecord.data.card.id]=listid},ensureListIsRegistered:function(listIdAndName){if(!this.listOrder[listIdAndName.id]){this.counterPerList[listIdAndName.id]=0;var listIdx=this.sizeOfObject(this.listOrder);this.listOrder[listIdAndName.id]={name:listIdAndName.name,id:listIdAndName.id,listIdx:listIdx,color:this.defaultColors[listIdx%this.defaultColors.length]}}},actionMoveCard:function(trelloActionRecord){var listidBefore=trelloActionRecord.data.listBefore.id,listidAfter=trelloActionRecord.data.listAfter.id;if(this.ensureListIsRegistered(trelloActionRecord.data.listBefore),this.ensureListIsRegistered(trelloActionRecord.data.listAfter),this.counterPerList[listidBefore]<=0){this.counterPerList[listidBefore]=1;for(var idx=this.listOrder[listidBefore].listIdx,i=Math.max(0,this.vizDataForJit.values.length-1);i--;)this.vizDataForJit.values[i].values[idx]=(this.vizDataForJit.values[i].values[idx]||0)+1}this.counterPerList[listidBefore]--,this.counterPerList[listidAfter]++,this.cardToListMap[trelloActionRecord.data.card.id]=listidAfter},processSingleTrelloActionRecord:function(recordIndex,trelloActionRecord){var unixtimestamp=trelloActionRecord.date,validData=!1,actions={},ignoreAction=function(){};actions.addMemberToCard=ignoreAction,actions.removeMemberFromCard=ignoreAction,actions.addChecklistToCard=ignoreAction,actions.copyCard=ignoreAction,actions.updateCheckItemStateOnCard=ignoreAction,actions.updateBoard=ignoreAction,actions.commentCard=ignoreAction,actions.moveCardFromBoard=ignoreAction,actions.convertToCardFromCheckItem=ignoreAction,actions.addAttachmentToCard=ignoreAction,actions.removeChecklistFromCard=ignoreAction,actions.updateChecklist=ignoreAction,actions.createBoard=ignoreAction,actions.addMemberToBoard=ignoreAction,actions.createList=function(){this.ensureListIsRegistered(trelloActionRecord.data.list)},actions.moveCardToBoard=function(){validData=this.actionArchiveCard(trelloActionRecord)},actions.createCard=function(){validData=!0,this.actionCreateCard(trelloActionRecord)},actions.updateCard=function(){1==trelloActionRecord.data.card.closed&&0==trelloActionRecord.data.old.closed&&(validData=this.actionArchiveCard(trelloActionRecord)),trelloActionRecord.data.listAfter&&trelloActionRecord.data.listBefore&&(validData=!0,this.actionMoveCard(trelloActionRecord))},actions[trelloActionRecord.type]?actions[trelloActionRecord.type].call(this):console.error("missing action, not handled: "+trelloActionRecord.type),validData&&this.vizDataForJit.values.push({label:unixtimestamp,values:this.retrieveValueRowWithNaturalOrder()})},retrieveValueRowWithNaturalOrder:function(){var valueRowWithNaturalOrder=[];for(var listid in this.listOrder){var idx=this.listOrder[listid].listIdx;valueRowWithNaturalOrder[idx]=this.counterPerList[listid]}return valueRowWithNaturalOrder},retrieveListsWithNaturalOrder:function(){var listsWithNaturalOrder=[];for(var listid in this.listOrder){var idx=this.listOrder[listid].listIdx;listsWithNaturalOrder[idx]=this.listOrder[listid]}return listsWithNaturalOrder},retrieveLabelNamesFromList:function(){for(var listid in this.listOrder){var idx=this.listOrder[listid].listIdx;this.vizDataForJit.label[idx]=this.listOrder[listid].name,this.vizDataForJit.color[idx]=this.defaultColors[idx%this.defaultColors.length]}},sizeOfObject:function(hashmap){var i=0;for(var key in hashmap)hashmap.hasOwnProperty(key)&&i++;return i}}};
//# sourceMappingURL=trelloviz.min.js.map